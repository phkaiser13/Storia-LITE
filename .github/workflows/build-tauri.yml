name: Build Tauri Client

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Add Windows target for Rust
        if: runner.os == 'Windows'
        run: rustup target add x86_64-pc-windows-msvc

      # Passo 1: Instalar as dependências do frontend (incluindo o Tauri CLI)
      # O diretório de trabalho é o do seu projeto Vite/TS.
      - name: Install frontend dependencies
        working-directory: ./src/WebClient
        run: npm install

      # Passo 2: Construir a aplicação Tauri
      # Este comando é executado a partir do WebClient, que contém o script "tauri".
      # O Tauri CLI irá então ler a configuração em ../Client/Tauri/src-tauri/tauri.conf.json
      # e executar o 'beforeBuildCommand' para compilar o frontend antes de empacotar.
      - name: Build Tauri application
        working-directory: ./src/WebClient
        run: npm run tauri build

      # Passo 3: Upload dos Artefatos (caminhos a partir da raiz do repositório)
      - name: Upload Windows Artifact
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: tauri-build-windows
          path: src/Client/Tauri/src-tauri/target/release/bundle/msi/*.msi

      - name: Upload macOS Artifact
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: tauri-build-macos
          path: src/Client/Tauri/src-tauri/target/release/bundle/dmg/*.dmg

      - name: Upload Linux Artifact
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: tauri-build-linux
          path: |
            src/Client/Tauri/src-tauri/target/release/bundle/appimage/*.AppImage
            src/Client/Tauri/src-tauri/target/release/bundle/deb/*.deb
